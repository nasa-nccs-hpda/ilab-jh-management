# Load the micromamba LMOD module.
sudo su - iluser
module load mamba
 
# This must be absolute path or jupyter lab build will fail.
10/17/25

export JL_ENV="/panfs/ccds02/app/modules/jupyter/ilab/jupyter-lab/ilab-juplab-ENV-current"

# Tune package versions as needed.

Build new ILab Dev Env WITHOUT ipyleaflet and install ipywidgets to get most updated ipywidgets. 
reason: When I tried to let ipyleaflet grab and install ipywidgets it got a lesser version of ipywidgets which is not what we want.

cd  $JL_ENV

micromamba create -y -p $JL_ENV -c rapidsai -c conda-forge python=3.12.8 pip jupyterhub=5.0.0 jupyterlab=4.2.5 nb_conda_kernels nodejs pycurl notebook git ipympl jupyter_contrib_nbextensions dask-labextension dask-jobqueue panel plotly jupyterlab-nvdashboard jupyter_bokeh jupyterlab-git jupyterlab-github jupyter-server-proxy pyvista ipywidgets plotnine mizani tiler hydra-core datasets webdataset rasterstats optuna dask-geopandas h5py pyarrow earthaccess huggingface_hub matplotlib-scalebar yacs timm torchgeo py-opencv earthengine-api hdf4 gdal

mm activate $JL_ENV

NOW go back and install ipyleaflet into the ILab DEV Juplab ENV to get the Jupyter_leaflet 0.19.2. This is the bridge to the kernel ipyleaflet. *note-Looks like it DID NOT try to install ipywidgets again, so that’s good!

micromamba install -c conda-forge ipyleaflet

Micromamba install localtileserver


pip install batchspawner wrapspawner
 
# Review changes to jupyter-server-proxy package on update (current v4.4.0)
wget "https://raw.githubusercontent.com/vic25pr/jupyter-server-proxy/refs/heads/body-size-increase/jupyter_server_proxy/handlers.py" -O "$(find $JL_ENV/lib -maxdepth 1 -type d -name 'python*')/site-packages/jupyter_server_proxy/handlers.py"# # 
 
# JupyterAI / ChatGSFC Integration
wget "https://gitlab.nccs.nasa.gov/nccs-jupyter/prism-chatgsfc-integration/-/raw/main/Config/nbi-config.json" -O $JL_ENV/share/jupyter/nbi-config.json
chmod 0644 $JL_ENV/share/jupyter/nbi-config.json
 
# A tmp dir is needed for local nodejs builds.
mkdir "$JL_ENV/tmp"
TMPDIR="$JL_ENV/tmp" jupyter lab build

# Copy json dir with json files (they contain the juplab kernel display names) over from previous env path version.  When the ILab JupLab ENV is created it only puts python3 directory in there. So I just copy the ilab-kernels and dev kernel from the previous env. *note-this is done every time you create a new ILab JupLab Env.

Ex:

cp -r /panfs/ccds02/app/modules/jupyter/ilab/jupyter-lab/ilab-juplab-env-NO-ipyleaflet-install-ipywidgets-directly/share/jupyter/kernels /panfs/ccds02/app/modules/jupyter/ilab/jupyter-lab/ilab-juplab-ENV-current/share/jupyter/kernels

[iluser@forest201 ~]$ cd /panfs/ccds02/app/modules/jupyter/ilab/jupyter-lab/dev/share/jupyter/kernels
[iluser@forest201 kernels]$ l
total 160
drwxr-s--- 2 iluser ilab 4096 Sep  8 18:27 dev
drwxr-s--- 2 iluser ilab 4096 Sep  8 18:27 ilab-kernel
drwxr-s--- 8 iluser ilab 4096 Sep  8 18:45 python3
drwxr-s--- 2 iluser ilab 4096 Oct 23 15:12 r-kernel
drwxr-s--- 2 iluser ilab 4096 Oct 23 15:12 tensorflow-kernel
